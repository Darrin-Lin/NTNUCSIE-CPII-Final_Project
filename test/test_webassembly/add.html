<!doctype html>
<html lang="en-us">

<head>
  <meta charset="utf-8">
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <title>WebAssembly example</title>
  <script src="add.js"></script>

  <script>
    function run_ws() {
      var a = document.getElementById("a").value;
      var b = document.getElementById("b").value;

      a = Math.floor(parseFloat(a));
      b = Math.floor(parseFloat(b));

      ret = Module._add(a, b);
      console.log(`${a} + ${b} = ${ret}`);

      var r = document.getElementById("ret");
      r.innerText = ret
      // Module._test();
      var ptr = Module._get_string();
      let str = (new TextDecoder()).decode(new Uint8Array(Module.HEAPU8.buffer, ptr, 15));
      console.log(str); 
      document.getElementById("img_png").src = str;

    }
    // const memory = new WebAssembly.Memory({ initial: 2 }); // Size is in pages

    // const mod = new WebAssembly.Module(byte)
    // // Instantiate your WebAssembly module
    // const instance = new WebAssembly.Instance(mod, { imports: { memory: memory } });

    // // Get the string size and index from WebAssembly
    // const size = instance.exports.myStringSize();
    // const index = instance.exports.myStringIndex();

    // // Read the string from the buffer
    // let s = "";
    // const buffer = new Uint8Array(memory.buffer);
    // for (let i = index; i < index + size; ++i) {
    //   s += String.fromCharCode(buffer[i]);
    // }
    // // Create a pointer using the 'Glue' method and the string value
    // const ptr = allocate(intArrayFromString(myStrValue), 'i8', ALLOC_NORMAL);
    // const memory = new WebAssembly.Memory({ initial: 10, maximum: 100 });
    // new Uint32Array(memory.buffer)[0];
    // // get the pointer to the memory
    // const ptr = Module._malloc(10);
    // // Call the WebAssembly method passing the pointer
    // const retPtr = Module._hello(ptr);
    // console.log(ptr);
    
  </script>
</head>

<body>
  <h1>WebAssembly in C</h1>
  <div style="display: inline-block;">
    <input id="a" type="number" />
    <label>+</label>
    <input id="b" type="number" />
    <button id="run_button" onclick="run_ws()">=</button>
    <label id="ret"></label>
  </div>
  <img id="img_png" src="./綠色乖乖.png" alt="綠色乖乖" width="100" height="100">
</body>

</html>